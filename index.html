<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Controle: Monitoramento de Consumo de Cigarros</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- Firebase Imports for persistent storage -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase objects globally for use in the main script block
        window.firebase = { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            where, 
            orderBy, 
            serverTimestamp,
            setLogLevel
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f4; /* Stone 100 */
            color: #1c1917; /* Stone 900 */
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 100%; 
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }

        @media (min-width: 1024px) {
            .chart-container-wide {
                max-width: 900px;
            }
            .chart-container-half {
                max-width: 500px;
            }
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(231, 229, 228, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f5f5f4; 
        }
        ::-webkit-scrollbar-thumb {
            background: #a8a29e; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #78716c; 
        }
    </style>
    <!-- Chosen Palette: Warm Neutrals (Stone/Orange). Stone for structure/calmness, Subtle Orange for data highlights/alerts. -->
</head>
<body class="flex flex-col min-h-screen">

    <!-- Navigation / Header -->
    <nav class="bg-stone-800 text-stone-100 shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">üö≠</span>
                    <h1 class="text-xl font-bold tracking-tight">Monitor de H√°bitos</h1>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <button onclick="scrollToSection('overview')" class="hover:bg-stone-700 px-3 py-2 rounded-md text-sm font-medium transition-colors">Vis√£o Geral</button>
                        <button onclick="scrollToSection('record-entry')" class="hover:bg-stone-700 px-3 py-2 rounded-md text-sm font-medium transition-colors">Novo Registro</button>
                        <button onclick="scrollToSection('financial')" class="hover:bg-stone-700 px-3 py-2 rounded-md text-sm font-medium transition-colors">Financeiro</button>
                        <button onclick="scrollToSection('context')" class="hover:bg-stone-700 px-3 py-2 rounded-md text-sm font-medium transition-colors">Contexto</button>
                        <button onclick="scrollToSection('log')" class="hover:bg-stone-700 px-3 py-2 rounded-md text-sm font-medium transition-colors">Registros</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

        <!-- Introduction -->
        <section id="overview" class="space-y-4">
            <div class="glass-panel p-6 rounded-xl">
                <h2 class="text-2xl font-bold text-stone-800 mb-2">Painel de Controle Di√°rio</h2>
                <p class="text-stone-600 leading-relaxed">
                    Este painel transforma os dados brutos do seu registro di√°rio em <i>insights</i> acion√°veis. 
                    O objetivo √© visualizar claramente a rela√ß√£o entre o <strong>gasto financeiro</strong> e a <strong>frequ√™ncia do h√°bito</strong>.
                    Utilize os cart√µes abaixo para ter uma vis√£o r√°pida do per√≠odo analisado e identificar tend√™ncias de consumo.
                </p>
                <div id="loadingMessage" class="mt-4 text-center text-orange-600 font-semibold">
                    Carregando dados...
                </div>
                <div id="authStatus" class="mt-4 text-xs text-stone-400 text-center">
                    Status de Autentica√ß√£o: Inicializando...
                </div>
            </div>

            <!-- KPIs -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Total Cigarettes -->
                <div class="glass-panel p-5 rounded-xl border-l-4 border-orange-500">
                    <p class="text-sm font-medium text-stone-500 uppercase">Cigarros Consumidos</p>
                    <p class="text-3xl font-bold text-stone-800 mt-1" id="kpi-total-cigs">--</p>
                    <p class="text-xs text-stone-400 mt-2">No per√≠odo selecionado</p>
                </div>
                
                <!-- Total Cost -->
                <div class="glass-panel p-5 rounded-xl border-l-4 border-stone-600">
                    <p class="text-sm font-medium text-stone-500 uppercase">Custo Total</p>
                    <p class="text-3xl font-bold text-stone-800 mt-1" id="kpi-total-cost">R$ --</p>
                    <p class="text-xs text-stone-400 mt-2">Gasto em ma√ßos</p>
                </div>

                <!-- Daily Average -->
                <div class="glass-panel p-5 rounded-xl border-l-4 border-stone-400">
                    <p class="text-sm font-medium text-stone-500 uppercase">M√©dia Di√°ria</p>
                    <p class="text-3xl font-bold text-stone-800 mt-1" id="kpi-avg-daily">--</p>
                    <p class="text-xs text-stone-400 mt-2">Cigarros por dia</p>
                </div>

                <!-- Packs Bought -->
                <div class="glass-panel p-5 rounded-xl border-l-4 border-orange-300">
                    <p class="text-sm font-medium text-stone-500 uppercase">Ma√ßos Comprados</p>
                    <p class="text-3xl font-bold text-stone-800 mt-1" id="kpi-packs">--</p>
                    <p class="text-xs text-stone-400 mt-2">Estoque adquirido</p>
                </div>
            </div>
        </section>

        <!-- Record Entry Section -->
        <section id="record-entry" class="glass-panel p-6 rounded-xl">
            <h2 class="text-2xl font-bold text-stone-800 mb-4">‚ûï Registrar Nova Entrada</h2>
            <p class="text-stone-600 leading-relaxed mb-6">
                Use este formul√°rio para adicionar um novo registro de consumo ou compra. O dashboard ser√° atualizado automaticamente ap√≥s a submiss√£o e o registro ser√° salvo permanentemente.
            </p>
            <form id="recordForm" class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                <!-- Row 1: Core Consumption Data -->
                <div class="md:col-span-1">
                    <label for="inputDate" class="block text-sm font-medium text-stone-700">Data *</label>
                    <input type="date" id="inputDate" required class="mt-1 block w-full rounded-lg border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 transition">
                </div>
                <div class="md:col-span-1">
                    <label for="inputTimeSmoked" class="block text-sm font-medium text-stone-700">Hora do Cigarro *</label>
                    <input type="time" id="inputTimeSmoked" required class="mt-1 block w-full rounded-lg border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 transition">
                </div>
                <div class="md:col-span-1">
                    <label for="inputCigQuantity" class="block text-sm font-medium text-stone-700">Qtd. Consumida *</label>
                    <select id="inputCigQuantity" required class="mt-1 block w-full rounded-lg border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 transition">
                        <option value="1">1 (Cigarro Inteiro)</option>
                        <option value="0.5">0.5 (Meio Cigarro)</option>
                    </select>
                </div>
                <div class="md:col-span-3">
                    <label for="inputContext" class="block text-sm font-medium text-stone-700">Atividade / Contexto *</label>
                    <input type="text" id="inputContext" required placeholder="Ex: Pausa no trabalho, Ap√≥s o almo√ßo, Estresse" class="mt-1 block w-full rounded-lg border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 transition">
                </div>

                <!-- Toggle for Purchase Info -->
                <div class="md:col-span-6 flex items-center mt-3">
                    <input id="togglePurchase" type="checkbox" class="h-4 w-4 text-orange-600 border-stone-300 rounded focus:ring-orange-500">
                    <label for="togglePurchase" class="ml-2 block text-sm text-stone-900 font-semibold">
                        Registrar Compra de Ma√ßo (Opcional)
                    </label>
                </div>
                
                <!-- Row 2: Purchase Data (Initially Hidden) -->
                <div id="purchaseFields" class="md:col-span-6 grid grid-cols-1 md:grid-cols-6 gap-4 border-t border-stone-200 pt-4 mt-2 hidden">
                    <div class="md:col-span-1">
                        <label for="inputTimeBought" class="block text-sm font-medium text-stone-700">Hora da Compra</label>
                        <input type="time" id="inputTimeBought" class="mt-1 block w-full rounded-lg border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 transition">
                    </div>
                    <div class="md:col-span-2">
                        <label for="inputPacksBought" class="block text-sm font-medium text-stone-700">Qtd. Ma√ßos (Un.)</label>
                        <input type="number" id="inputPacksBought" min="1" value="1" class="mt-1 block w-full rounded-lg border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 transition">
                    </div>
                    <div class="md:col-span-2">
                        <label for="inputPackValue" class="block text-sm font-medium text-stone-700">Valor do Ma√ßo (R$)</label>
                        <input type="number" id="inputPackValue" step="0.01" value="15.00" class="mt-1 block w-full rounded-lg border-stone-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 transition">
                    </div>
                    <div class="md:col-span-1">
                        <button type="submit" id="purchaseSaveButton" disabled class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-orange-400 cursor-not-allowed transition-all">
                            Salvar Registro
                        </button>
                    </div>
                </div>

                <!-- Save Button if no purchase is checked -->
                <div id="saveNoPurchase" class="md:col-span-6 flex justify-end mt-3">
                    <button type="submit" id="consumptionSaveButton" disabled class="w-full md:w-auto py-2 px-6 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-stone-400 cursor-not-allowed transition-all">
                        Salvar Apenas Consumo
                    </button>
                </div>

            </form>
        </section>


        <!-- Financial & Trend Analysis -->
        <section id="financial" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 glass-panel p-6 rounded-xl">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                    <div>
                        <h3 class="text-lg font-bold text-stone-800">Tend√™ncia: Custo vs. Consumo</h3>
                        <p class="text-sm text-stone-500">Comparativo di√°rio entre cigarros fumados (barras) e dinheiro gasto (linha).</p>
                    </div>
                </div>
                <div class="w-full flex justify-center">
                    <div class="chart-container chart-container-wide">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Side Card: Projection -->
            <div class="glass-panel p-6 rounded-xl flex flex-col justify-center space-y-6">
                <h3 class="text-lg font-bold text-stone-800">Proje√ß√£o Mensal</h3>
                <p class="text-sm text-stone-600">
                    Com base na m√©dia atual, esta √© a estimativa para o final de um m√™s de 30 dias.
                </p>
                
                <div class="space-y-4">
                    <div class="bg-stone-100 p-4 rounded-lg">
                        <p class="text-sm text-stone-500 mb-1">Custo Estimado Mensal</p>
                        <p class="text-2xl font-bold text-orange-600" id="proj-cost">R$ --</p>
                    </div>
                    <div class="bg-stone-100 p-4 rounded-lg">
                        <p class="text-sm text-stone-500 mb-1">Cigarros Estimados</p>
                        <p class="text-2xl font-bold text-stone-700" id="proj-cigs">--</p>
                    </div>
                </div>
                <p class="text-xs text-stone-400 italic text-center">
                    *C√°lculo baseado na m√©dia di√°ria do per√≠odo atual.
                </p>
            </div>
        </section>

        <!-- Context & Behavior -->
        <section id="context" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Doughnut Chart: Activities -->
            <div class="glass-panel p-6 rounded-xl">
                <div class="mb-4">
                    <h3 class="text-lg font-bold text-stone-800">Gatilhos e Contexto</h3>
                    <p class="text-sm text-stone-500">O que voc√™ estava fazendo no momento do consumo?</p>
                </div>
                <div class="w-full flex justify-center">
                    <div class="chart-container chart-container-half">
                        <canvas id="contextChart"></canvas>
                    </div>
                </div>
                <div id="context-legend" class="mt-4 flex flex-wrap justify-center gap-2 text-xs text-stone-600">
                    <!-- Dynamic Legend -->
                </div>
            </div>

            <!-- Scatter Plot: Time Analysis -->
            <div class="glass-panel p-6 rounded-xl">
                <div class="mb-4">
                    <h3 class="text-lg font-bold text-stone-800">Ritmo Di√°rio</h3>
                    <p class="text-sm text-stone-500">Hor√°rios de consumo e compra ao longo dos dias.</p>
                </div>
                <div class="w-full flex justify-center items-center bg-white rounded-lg border border-stone-100 p-2">
                    <div class="chart-container chart-container-wide" id="timeScatterChart"></div>
                </div>
            </div>
        </section>

        <!-- Detailed Log -->
        <section id="log" class="glass-panel rounded-xl overflow-hidden">
            <div class="p-6 border-b border-stone-200 bg-stone-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div>
                    <h3 class="text-lg font-bold text-stone-800">Registro Detalhado</h3>
                    <p class="text-sm text-stone-500">Hist√≥rico completo de entradas.</p>
                </div>
                <div class="relative">
                    <input type="text" id="tableSearch" placeholder="Filtrar por contexto..." 
                           class="pl-10 pr-4 py-2 border border-stone-300 rounded-lg text-sm focus:ring-2 focus:ring-stone-400 focus:outline-none w-full sm:w-64 transition-shadow">
                    <span class="absolute left-3 top-2.5 text-stone-400">üîç</span>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-stone-100 text-stone-600 font-semibold uppercase text-xs">
                        <tr>
                            <th class="px-6 py-4">Data</th>
                            <th class="px-6 py-4">Hora</th>
                            <th class="px-6 py-4">Contexto</th>
                            <th class="px-6 py-4 text-center">Compra</th>
                            <th class="px-6 py-4 text-right">Custo (R$)</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="divide-y divide-stone-100 bg-white">
                        <!-- Rows generated by JS -->
                    </tbody>
                </table>
            </div>
            <div class="p-4 bg-stone-50 border-t border-stone-200 text-center text-xs text-stone-400">
                Fim dos registros
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-stone-800 text-stone-400 py-8 mt-8">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-sm">@2025 Criado por Maur√≠cio Campos <i> - Engenheiro de Software e Ci√™ntista e Analista de Dados</i></p>
        </div>
    </footer>

    <!-- Logic -->
    <script>
        // --- 1. Firebase & Data Setup ---
        let appData = [];
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        const collectionName = "cigaretteTrackerEntries";
        
        // Fun√ß√£o para controlar o estado dos bot√µes do formul√°rio (fix para o erro de carregamento)
        function setFormState(ready) {
            const consumptionSaveButton = document.getElementById('consumptionSaveButton');
            const purchaseSaveButton = document.getElementById('purchaseSaveButton');
            
            if (consumptionSaveButton && purchaseSaveButton) {
                if (ready) {
                    // Estado Pronto: Habilita bot√µes e ajusta classes de cor/cursor
                    consumptionSaveButton.classList.remove('bg-stone-400', 'cursor-not-allowed');
                    consumptionSaveButton.classList.add('bg-stone-600', 'hover:bg-stone-700');
                    
                    purchaseSaveButton.classList.remove('bg-orange-400', 'cursor-not-allowed');
                    purchaseSaveButton.classList.add('bg-orange-600', 'hover:bg-orange-700');

                    // Verifica o estado atual do checkbox de compra para definir qual bot√£o fica ativo
                    if (document.getElementById('togglePurchase').checked) {
                        consumptionSaveButton.disabled = true;
                        purchaseSaveButton.disabled = false;
                    } else {
                        consumptionSaveButton.disabled = false;
                        purchaseSaveButton.disabled = true;
                    }
                    
                } else {
                    // Estado Inicial/Carregando: Desabilita bot√µes e usa classes de inatividade
                    consumptionSaveButton.disabled = true;
                    consumptionSaveButton.classList.add('bg-stone-400', 'cursor-not-allowed');
                    consumptionSaveButton.classList.remove('bg-stone-600', 'hover:bg-stone-700');

                    purchaseSaveButton.disabled = true;
                    purchaseSaveButton.classList.add('bg-orange-400', 'cursor-not-allowed');
                    purchaseSaveButton.classList.remove('bg-orange-600', 'hover:bg-orange-700');
                }
            }
        }


        function initFirebase() {
            if (typeof window.firebase === 'undefined') {
                console.error("Firebase library not loaded.");
                return;
            }

            const firebase = window.firebase;
            
            try {
                <script type="module">
 
                  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
 

 
                  const firebaseConfig = {
                    apiKey: "AIzaSyCt8rWuKVi6S8cG1GUpa1MGfOGLz_5m-UM",
                    authDomain: "mapeamentocigarros.firebaseapp.com",
                    projectId: "mapeamentocigarros",
                    storageBucket: "mapeamentocigarros.firebasestorage.app",
                    messagingSenderId: "911298596636",
                    appId: "1:911298596636:web:12b5fa79299936e40b34d9"
                  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
</script>

                // Tenta pegar do ambiente (se estiver no editor) ou usa a configura√ß√£o manual (se estiver no GitHub)
                let firebaseConfig;
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                     firebaseConfig = JSON.parse(__firebase_config);
                } else {
                     // Verifica se o usu√°rio preencheu a configura√ß√£o
                     if (seus_dados_firebase_aqui.apiKey === "SUA_API_KEY_AQUI") {
                         alert("Aten√ß√£o: Voc√™ precisa configurar o Firebase no c√≥digo para que o salvamento funcione no GitHub Pages. Procure por 'seus_dados_firebase_aqui' no arquivo index.html.");
                     }
                     firebaseConfig = seus_dados_firebase_aqui;
                }
                
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.getFirestore(app);
                auth = firebase.getAuth(app);
                
                // Set initial form state to disabled
                document.getElementById('loadingMessage').classList.remove('hidden');
                setFormState(false);
                
                // Authentication listener
                firebase.onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('authStatus').textContent = `Status de Autentica√ß√£o: Conectado (ID: ${userId})`;
                        isAuthReady = true;
                        setFormState(true); // Habilita bot√µes ap√≥s a autentica√ß√£o!
                        
                        // Start listening to data changes
                        listenToRecords(); 
                    } else {
                        // Sign in anonymously if no token is available or user is signed out
                        if (initialAuthToken) {
                            await firebase.signInWithCustomToken(auth, initialAuthToken).catch(error => {
                                console.error("Error signing in with custom token:", error);
                                firebase.signInAnonymously(auth);
                            });
                        } else {
                            await firebase.signInAnonymously(auth).catch(error => {
                                console.error("Error signing in anonymously:", error);
                            });
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('authStatus').textContent = 'Erro de inicializa√ß√£o do Firebase. Verifique suas credenciais no c√≥digo.';
            }
        }
        
        // --- 2. Firestore Listener ---

        function listenToRecords() {
            if (!db || !userId) {
                return;
            }
            
            // Usamos uma cole√ß√£o raiz se o __app_id n√£o existir (caso do GitHub Pages)
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'meu-rastreador-pessoal';
            const collectionPath = `/artifacts/${appId}/users/${userId}/${collectionName}`;
            
            // Query para buscar e ordenar os registros do usu√°rio atual.
            const q = firebase.query(
                firebase.collection(db, collectionPath),
                firebase.orderBy("createdAt", "asc") 
            );

            firebase.onSnapshot(q, (snapshot) => {
                const updatedData = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Garante que o cigsConsumed seja tratado como float, pois pode ser 0.5
                    const consumed = parseFloat(data.cigsConsumed) || 0;
                    updatedData.push({
                        id: doc.id,
                        date: data.date,
                        timeSmoked: data.timeSmoked,
                        context: data.context,
                        timeBought: data.timeBought || null,
                        packsBought: data.packsBought || 0,
                        packValue: data.packValue || 0,
                        cigsConsumed: consumed, 
                        cost: data.cost || 0
                    });
                });

                appData = updatedData;
                refreshDashboard(); // Atualiza a UI com os novos dados
                document.getElementById('loadingMessage').classList.add('hidden');
            }, (error) => {
                console.error("Error listening to documents:", error);
                document.getElementById('loadingMessage').textContent = 'Erro ao carregar dados. Verifique as regras do Firestore.';
            });
        }
        
        // --- 3. UI Update Logic (Refactored to run after data load) ---
        
        function refreshDashboard() {
             // Re-sort data to ensure charts are always in the correct order (by date/time)
            appData.sort((a, b) => {
                const parseDate = (dateStr, timeStr) => {
                    const [day, month, year] = dateStr.split('/');
                    const [hour, minute] = timeStr.split(':');
                    return new Date(year, month - 1, day, hour, minute).getTime();
                };
                return parseDate(a.date, a.timeSmoked) - parseDate(b.date, b.timeSmoked);
            });
            
            const stats = getAggregatedStats(appData);

            renderKPIs(stats);
            renderTrendChart(stats.dailyStats);
            renderContextChart(stats.contextCounts);
            renderScatterPlot(appData);
            renderTable(appData);
        }

        // Global Chart instances to allow for destruction/update
        let trendChartInstance = null;
        let contextChartInstance = null;
        
        // --- 4. Analytics Helper Functions (No change, uses appData) ---
        
        function getAggregatedStats(data) {
            let totalCigs = 0;
            let totalCost = 0;
            let totalPacks = 0;
            const uniqueDates = new Set();
            const contextCounts = {};
            const dailyStats = {};

            data.forEach(item => {
                totalCigs += item.cigsConsumed; // Agora pode somar 0.5
                totalCost += item.cost;
                totalPacks += item.packsBought;
                uniqueDates.add(item.date);

                // Context
                if (contextCounts[item.context]) {
                    contextCounts[item.context] += item.cigsConsumed; // Soma quantidade fracionada ao contexto
                } else {
                    contextCounts[item.context] = item.cigsConsumed;
                }

                // Daily Stats
                if (!dailyStats[item.date]) {
                    dailyStats[item.date] = { cigs: 0, cost: 0 };
                }
                dailyStats[item.date].cigs += item.cigsConsumed;
                dailyStats[item.date].cost += item.cost;
            });

            const daysCount = uniqueDates.size || 1;

            return {
                totalCigs: totalCigs.toFixed(1), // Total com 1 casa decimal
                totalCost,
                totalPacks,
                daysCount,
                avgCigs: (totalCigs / daysCount).toFixed(1),
                avgCost: (totalCost / daysCount).toFixed(2),
                contextCounts,
                dailyStats
            };
        }

        // --- 5. Rendering Functions (No change) ---

        function renderKPIs(stats) {
            document.getElementById('kpi-total-cigs').textContent = stats.totalCigs || 0;
            document.getElementById('kpi-total-cost').textContent = `R$ ${stats.totalCost.toFixed(2).replace('.', ',')}`;
            document.getElementById('kpi-avg-daily').textContent = stats.avgCigs || 0;
            document.getElementById('kpi-packs').textContent = stats.totalPacks || 0;

            // Projections (30 days)
            const projCost = (parseFloat(stats.avgCost || 0) * 30).toFixed(2).replace('.', ',');
            const projCigs = (parseFloat(stats.avgCigs || 0) * 30).toFixed(1);
            
            document.getElementById('proj-cost').textContent = `R$ ${projCost}`;
            document.getElementById('proj-cigs').textContent = projCigs;
        }

        function renderTrendChart(dailyStats) {
            if (trendChartInstance) {
                trendChartInstance.destroy();
            }

            const ctx = document.getElementById('trendChart').getContext('2d');
            const dates = Object.keys(dailyStats);
            const cigsData = dates.map(d => dailyStats[d].cigs);
            const costData = dates.map(d => dailyStats[d].cost);

            trendChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Custo (R$)',
                            data: costData,
                            type: 'line',
                            borderColor: '#ea580c',
                            backgroundColor: '#ea580c',
                            borderWidth: 2,
                            tension: 0.3,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Cigarros Fumados',
                            data: cigsData,
                            backgroundColor: '#a8a29e',
                            borderRadius: 4,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        if (context.datasetIndex === 0) {
                                            label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed.y);
                                        } else {
                                            // Exibe a quantidade com uma casa decimal (0.5 ou 1.0)
                                            label += context.parsed.y.toFixed(1) + ' un.'; 
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Quantidade' },
                            beginAtZero: true,
                            grid: { display: false }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Custo (R$)' },
                            beginAtZero: true,
                            grid: { borderDash: [2, 4], color: '#e7e5e4' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function renderContextChart(contextCounts) {
            if (contextChartInstance) {
                contextChartInstance.destroy();
            }
            
            const ctx = document.getElementById('contextChart').getContext('2d');
            const labels = Object.keys(contextCounts);
            const data = Object.values(contextCounts);

            const colors = ['#ea580c', '#f97316', '#fdba74', '#78716c', '#a8a29e', '#d6d3d1', '#e7e5e4', '#a16207'];

            contextChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                padding: 15,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    return `${label}: ${value.toFixed(1)} un.`;
                                }
                            }
                        }
                    },
                    cutout: '65%'
                }
            });
        }

        function renderScatterPlot(data) {
            const smokeTrace = {
                x: [],
                y: [],
                mode: 'markers',
                type: 'scatter',
                name: 'Cigarro',
                text: [],
                marker: { size: 10, color: '#78716c' }
            };

            const buyTrace = {
                x: [],
                y: [],
                mode: 'markers',
                type: 'scatter',
                name: 'Compra',
                text: [],
                marker: { size: 14, color: '#ea580c', symbol: 'star' }
            };

            data.forEach(item => {
                const dummyDate = '2000-01-01 ';
                
                smokeTrace.x.push(dummyDate + item.timeSmoked);
                smokeTrace.y.push(item.date);
                smokeTrace.text.push(`Contexto: ${item.context} (${item.cigsConsumed.toFixed(1)} un.)`);

                if (item.timeBought) {
                    buyTrace.x.push(dummyDate + item.timeBought);
                    buyTrace.y.push(item.date);
                    buyTrace.text.push(`Qtd: ${item.packsBought} ma√ßo(s) - R$ ${item.cost.toFixed(2)}`);
                }
            });

            const layout = {
                margin: { t: 20, r: 20, b: 40, l: 80 },
                xaxis: {
                    type: 'date',
                    tickformat: '%H:%M',
                    title: 'Hora do Dia',
                    color: '#57534e'
                },
                yaxis: {
                    type: 'category',
                    title: '',
                    color: '#57534e'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                showlegend: true,
                legend: { orientation: 'h', y: -0.2 }
            };

            const config = { responsive: true, displayModeBar: false };

            Plotly.newPlot('timeScatterChart', [smokeTrace, buyTrace], layout, config);
        }

        function renderTable(data) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="5" class="px-6 py-4 text-center text-stone-400 italic">Nenhum registro encontrado. Comece a adicionar entradas acima!</td>`;
                tbody.appendChild(tr);
                return;
            }

            // Sort by Date (descending) then Time (descending)
            const sortedData = [...data].sort((a, b) => {
                const parseDate = (dateStr, timeStr) => {
                    const [day, month, year] = dateStr.split('/');
                    const [hour, minute] = timeStr.split(':');
                    return new Date(year, month - 1, day, hour, minute).getTime();
                };
                return parseDate(b.date, b.timeSmoked) - parseDate(a.date, a.timeSmoked);
            });

            sortedData.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-stone-50 transition-colors';
                
                const purchaseInfo = item.packsBought > 0 
                    ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-800">${item.packsBought} un.</span>` 
                    : '<span class="text-stone-300">-</span>';

                const costClass = item.cost > 0 ? 'text-stone-800 font-bold' : 'text-stone-300';
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-stone-700 font-medium">${item.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-stone-600">${item.timeSmoked}</td>
                    <td class="px-6 py-4 text-stone-600">${item.context} (${item.cigsConsumed.toFixed(1)} un.)</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">${purchaseInfo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right ${costClass}">
                        ${item.cost > 0 ? 'R$ ' + item.cost.toFixed(2).replace('.', ',') : '-'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 6. Record Entry Logic (Now using Firestore) ---

        document.getElementById('togglePurchase').addEventListener('change', function() {
            const purchaseFields = document.getElementById('purchaseFields');
            const saveNoPurchase = document.getElementById('saveNoPurchase');
            
            // Re-evaluates button state based on new toggle state and Firebase readiness
            setFormState(isAuthReady);
            
            if (this.checked) {
                purchaseFields.classList.remove('hidden');
                saveNoPurchase.classList.add('hidden');
            } else {
                purchaseFields.classList.add('hidden');
                saveNoPurchase.classList.remove('hidden');
            }
        });

        document.getElementById('recordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!isAuthReady || !db || !userId) {
                 // Enhanced message for the user, indicating they must wait for loading
                 alert('O sistema de banco de dados ainda est√° carregando ou houve um erro de conex√£o. Por favor, aguarde o status de "Conectado" e tente novamente.');
                 return;
            }

            const dateInput = document.getElementById('inputDate').value;
            const timeSmokedInput = document.getElementById('inputTimeSmoked').value;
            const contextInput = document.getElementById('inputContext').value;
            const cigQuantityInput = document.getElementById('inputCigQuantity').value; // Novo campo
            const isPurchase = document.getElementById('togglePurchase').checked;

            if (!dateInput || !timeSmokedInput || !contextInput || !cigQuantityInput) {
                const message = 'Por favor, preencha a Data, Hora do Cigarro, Quantidade e Contexto.';
                alert(message); 
                return;
            }

            let packsBought = 0;
            let packValue = 0.00;
            let timeBought = null;
            let cost = 0.00;

            if (isPurchase) {
                timeBought = document.getElementById('inputTimeBought').value || timeSmokedInput;
                packsBought = parseInt(document.getElementById('inputPacksBought').value) || 0;
                packValue = parseFloat(document.getElementById('inputPackValue').value) || 0;
                
                cost = packsBought * packValue;
            }

            const [year, month, day] = dateInput.split('-');
            const formattedDate = `${day}/${month}/${year}`;
            
            const newRecord = {
                // Campos de dados
                date: formattedDate,
                timeSmoked: timeSmokedInput,
                context: contextInput,
                timeBought: timeBought,
                packsBought: packsBought,
                packValue: packValue,
                cigsConsumed: parseFloat(cigQuantityInput), // Salva o valor fracionado
                cost: cost,
                // Campo crucial para o multiusu√°rio e ordena√ß√£o no Firestore
                userId: userId, 
                createdAt: firebase.serverTimestamp() 
            };

            try {
                // Usando o caminho private para o usu√°rio logado
                // Usamos uma cole√ß√£o raiz se o __app_id n√£o existir (caso do GitHub Pages)
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'meu-rastreador-pessoal';
                const collectionPath = `/artifacts/${appId}/users/${userId}/${collectionName}`;
                await firebase.addDoc(firebase.collection(db, collectionPath), newRecord);

                // Clear the form and reset purchase fields state
                document.getElementById('recordForm').reset();
                document.getElementById('togglePurchase').checked = false;
                document.getElementById('purchaseFields').classList.add('hidden');
                document.getElementById('saveNoPurchase').classList.remove('hidden');
                
                scrollToSection('overview');

                // The UI update (refreshDashboard) will happen automatically via onSnapshot listener!
                alert(`Registro salvo com sucesso (e permanentemente)! Consumo: ${newRecord.cigsConsumed.toFixed(1)} un.`);

            } catch (error) {
                console.error("Error writing document:", error);
                alert("Erro ao salvar o registro. Verifique a conex√£o.");
            }
        });


        // --- 7. Search/Filter Logic (No change) ---
        document.getElementById('tableSearch').addEventListener('input', function(e) {
            const term = e.target.value.toLowerCase();
            const filtered = appData.filter(item => 
                item.context.toLowerCase().includes(term) || 
                item.date.includes(term)
            );
            renderTable(filtered);
        });

        // --- 8. Navigation (No change) ---
        function scrollToSection(id) {
            const element = document.getElementById(id);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // --- 9. Initialization ---
        function init() {
            initFirebase();
            // Initial render with empty data until Firestore loads
            refreshDashboard();
        }

        // Boot
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
